title: “迹”APP & 目标追踪小车Tmp
date: 2016-05-05 16:32:05
tags:
- 项目
- OpenCV
- Android
- Arduino
---
**<font size = "4px">“迹” for Android</font>** 

>“迹”是一个基于OpenCV的图像处理APP，它可以让手机通过摄像头实时跟踪设定的颜色目标，并且通过手机蓝牙将目标坐标位置和大小等信息输出，配合蓝牙串口模块和我写的配套Arduino数据接收库，可以实现很多有趣的功能~ 这篇文章主要讲解一下“迹”的使用方法，以及如何通过目标追踪功能制作一个简单的小车。

    APP软件运行界面：


![加载失败,请刷新](/img/trace.gif)![加载失败,请刷新](/img/trace01.png)

    安装方法

- **直接安装Trace.apk，Android5.0以上系统需要到设置里赋予应用相机和蓝牙权限**


    使用方法

- 进软件之后可以点击连接蓝牙，选择你的蓝牙模块（模块需要事先在手机系统蓝牙设置里面配对好），连接上之后如果有目标信息就会通过蓝牙发送到模块上，Arduino进行读取就可以了。

- 点击左上角的按钮进入预览画面，此时在预览窗口中点击任何一个你想追踪的物体，就会自动进行处理输出数据了，顶栏会显示你选中的颜色。

- 这里说明一下，跟踪原理是以颜色为特征的，所以应该尽量避免视野中出现颜色相同的物体，同时如果发现跟踪物体的周围出现大量小块的目标块，可以适当调大屏幕下方的进度条，直到杂块消失只剩一个目标。

**说明一下屏幕下方各个控件的含义：**
- 左边的按钮是切换手机前后镜头的（现在应该没有不带前置镜头的手机了吧...）
- 进度条用于调节图像处理阈值，这个值用于色块过滤，可以理解为，用于设置最小的目标块的限制，也就是当目标小于一定程度就过滤掉。
- T、X、Y三个参数是目标的信息，XY是坐标大家都知道（坐标的最大值跟手机镜头分辨率有关）；T是目标的大小信息，如果检测到多个目标或者没有检测到任何目标这里会显示E（error）。T可以用于粗略得判断物体的远近（近大远小），不过更推荐的方式是用Y轴判断远近（见后文的小车）。

<font color="#4590a3" size = "4px">演示视频</font>  
<div style="height: 0;padding-bottom: 61%;position: relative;">
<iframe width="560" height="315" src="http://player.youku.com/embed/XMTU2MTc0NTgxNg" frameborder="0" allowfullscreen="" style="position: absolute;height: 100%;width: 100%;"></iframe>
</div>  

<br /> 
<!--more-->

    一个应用Demo：跟踪小车Tmp

利用迹得到的数据，我们就可以做个跟踪目标的小机器人了~
APP完成之后临时搭了个简陋的小车用来测试效果
![加载失败,请刷新](/img/trace02.jpg)
是不是看着就像临时工![加载失败,请刷新](/img/trace03.png)
<font color="#4590a3" size = "4px">演示视频</font>  
<div style="height: 0;padding-bottom: 61%;position: relative;">
<iframe width="560" height="315" src="http://player.youku.com/embed/XMTU2MTAzMDk0OA" frameborder="0" allowfullscreen="" style="position: absolute;height: 100%;width: 100%;"></iframe>
</div>  

<br /> 

这个小车大家可以随意搭建，只要能把你的手机放上去就行。Tmp上我用了两个舵机改造成轮子，把180度的舵机改成可以连续旋转的360舵机，这样就省下了电机驱动以及麻烦的减速箱，而且只用一根信号线就可以控制电机的正反转和速度，这部分要是大家感兴趣可以上网搜搜相关改造教程。

然后我们需要把小车和手机联系起来，通过蓝牙模块：
![加载失败,请刷新](/img/trace04.jpg)
需要使用从机模块，最好把波特率设置为115200，连线如下：
**蓝牙模块        Arduino
Tx        ->    Rx
Vcc       ->    5V
Gnd       ->    Gnd**
- 注意蓝牙的Rx是不接Arduino的，因为Arduino只需要接收APP的数据而不需要发送，这样的话留出的Tx就可以通过Serial.Print()打印到电脑端的串口助手。
- 当然，考虑到一般Arduino都只有一个硬件串口，这样串口被蓝牙模块占用了之后***每次下载都需要拔下蓝牙***以避免数据串扰，解决办法是换用软串口或者换用Mega等不止一个串口的板子。
- 软件部分，提供已经封装好的Arduino库，放到library文件夹后打开示例就会用了
  ![加载失败,请刷新](/img/trace05.png)

- 需要自己完成的部分就是，把获取到的x，y坐标转换为小车电机的速度，思路是这样的：
- 假设我们希望目标始终在屏幕中间，那么当y坐标大于屏幕y最大值的一半时让车有一个往前的基础速度V，反 之则是向后的基础速度-V；
- 如果x坐标大于屏幕x最大值的一半，那么让车子有一个旋转速度Vt，反之有个旋转速度-Vt；
  最后赋值给小车的速度是：左轮 = V+Vt,右轮 = V-Vt，也就是所谓的差速驱动了。

最后给出APP和Arduino库的下载地址：
[点击下载](http://pan.baidu.com/s/1pKUJ9A7)
也可以去豌豆荚搜索“迹”下载安装。

祝大家玩得开心，做出了什么好玩的项目也可以发出来给大家参考一下~

如果觉得我的工作对你有帮助，想请我喝可乐的话，欢迎支付宝投食~
![加载失败,请刷新](/img/trace06.jpg)






